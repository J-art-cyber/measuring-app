import streamlit as st
import pandas as pd
import gspread
import json
import re
import io
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime

st.set_page_config(page_title="æ¡å¯¸ãƒ‡ãƒ¼ã‚¿ç®¡ç†", layout="wide")
page = st.sidebar.selectbox("ãƒšãƒ¼ã‚¸ã‚’é¸æŠ", ["æ¡å¯¸å…¥åŠ›", "æ¡å¯¸æ¤œç´¢", "å•†å“ã‚¤ãƒ³ãƒãƒ¼ãƒˆ", "æ¡å¯¸ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–"])

# Google Sheetsèªè¨¼
scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
json_key = json.loads(st.secrets["GOOGLE_CREDENTIALS"])
creds = ServiceAccountCredentials.from_json_keyfile_dict(json_key, scope)
client = gspread.authorize(creds)
spreadsheet = client.open("æ¡å¯¸ç®¡ç†ãƒ‡ãƒ¼ã‚¿")

# ã‚«ãƒ†ã‚´ãƒªåˆ¥ç†æƒ³é †
ideal_order_dict = {
    "ã‚¸ãƒ£ã‚±ãƒƒãƒˆ": ["è‚©å¹…", "èƒ¸å¹…", "èƒ´å›²", "è¢–ä¸ˆ", "ç€ä¸ˆ"],
    "ãƒ‘ãƒ³ãƒ„": ["ã‚¦ã‚¨ã‚¹ãƒˆ", "è‚¡ä¸Š", "è‚¡ä¸‹", "ãƒ¯ã‚¿ãƒª", "è£¾å¹…"],
    "ãƒ€ã‚¦ãƒ³": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ", "è¥Ÿé«˜"],
    "ãƒ–ãƒ«ã‚¾ãƒ³": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ", "è¥Ÿé«˜"],
    "ã‚³ãƒ¼ãƒˆ": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ", "è¥Ÿé«˜"],
    "ãƒ‹ãƒƒãƒˆ": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ"],
    "ã‚«ãƒƒãƒˆã‚½ãƒ¼": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ"],
    "ãƒ¬ã‚¶ãƒ¼": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ", "è¥Ÿé«˜"],
    "é´": ["å…¨é•·", "æœ€å¤§å¹…"],
    "å·»ç‰©": ["å…¨é•·", "æ¨ªå¹…"],
    "å°ç‰©ãƒ»ãã®ä»–": ["é ­å‘¨ã‚Š", "ãƒ„ãƒ", "é«˜ã•", "æ¨ªå¹…", "ãƒãƒ"],
    "ã‚·ãƒ£ãƒ„": ["è‚©å¹…", "è£„ä¸ˆ", "èƒ¸å¹…", "èƒ´å›²", "è¢–ä¸ˆ", "ç€ä¸ˆ"],
    "ã‚·ãƒ£ãƒ„ã‚¸ãƒ£ã‚±ãƒƒãƒˆ": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "ç€ä¸ˆ"],
    "ã‚¹ãƒ¼ãƒ„": ["è‚©å¹…", "èƒ¸å¹…", "èƒ´å›²", "è¢–ä¸ˆ", "ç€ä¸ˆ", "ã‚¦ã‚¨ã‚¹ãƒˆ", "è‚¡ä¸Š", "è‚¡ä¸‹", "ãƒ¯ã‚¿ãƒª", "è£¾å¹…"],
    "ãƒ™ãƒ«ãƒˆ": ["å…¨é•·", "ãƒ™ãƒ«ãƒˆå¹…"],
    "åŠè¢–": ["è‚©å¹…", "èƒ¸å¹…", "è¢–ä¸ˆ", "å‰ä¸ˆ", "å¾Œä¸ˆ"]
}

# ğŸ” æ¡å¯¸æ¤œç´¢ãƒšãƒ¼ã‚¸
if page == "æ¡å¯¸æ¤œç´¢":
    st.title("ğŸ” æ¡å¯¸çµæœæ¤œç´¢")
    try:
        result_df = pd.DataFrame(spreadsheet.worksheet("æ¡å¯¸çµæœ").get_all_records())

        selected_brands = st.multiselect("ğŸ”¸ ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’é¸æŠ", sorted(result_df["ãƒ–ãƒ©ãƒ³ãƒ‰"].dropna().unique()))
        selected_pids = st.multiselect("ğŸ”¹ ç®¡ç†ç•ªå·ã‚’é¸æŠ", sorted(result_df["å•†å“ç®¡ç†ç•ªå·"].dropna().unique()))
        selected_sizes = st.multiselect("ğŸ”º ã‚µã‚¤ã‚ºã‚’é¸æŠ", sorted(result_df["ã‚µã‚¤ã‚º"].dropna().unique()))
        keyword = st.text_input("ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆå•†å“åã€ç®¡ç†ç•ªå·ãªã©ï¼‰")
        category_filter = st.selectbox("ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã§è¡¨ç¤ºé …ç›®ã‚’çµã‚‹", ["ã™ã¹ã¦è¡¨ç¤º"] + sorted(result_df["ã‚«ãƒ†ã‚´ãƒª"].dropna().unique()))

        # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
        if selected_brands:
            result_df = result_df[result_df["ãƒ–ãƒ©ãƒ³ãƒ‰"].isin(selected_brands)]
        if selected_pids:
            result_df = result_df[result_df["å•†å“ç®¡ç†ç•ªå·"].isin(selected_pids)]
        if selected_sizes:
            result_df = result_df[result_df["ã‚µã‚¤ã‚º"].isin(selected_sizes)]
        if keyword:
            result_df = result_df[result_df.apply(lambda row: keyword.lower() in str(row.values).lower(), axis=1)]
        if category_filter != "ã™ã¹ã¦è¡¨ç¤º":
            result_df = result_df[result_df["ã‚«ãƒ†ã‚´ãƒª"] == category_filter]

        # ä¸¦ã³é †èª¿æ•´
        base_cols = ["æ—¥ä»˜", "å•†å“ç®¡ç†ç•ªå·", "ãƒ–ãƒ©ãƒ³ãƒ‰", "ã‚«ãƒ†ã‚´ãƒª", "å•†å“å", "ã‚«ãƒ©ãƒ¼", "ã‚µã‚¤ã‚º"]
        current_category = category_filter if category_filter != "ã™ã¹ã¦è¡¨ç¤º" else None
        ideal_cols = ideal_order_dict.get(current_category, [])
        ordered_cols = base_cols + [col for col in ideal_cols if col in result_df.columns] + [
            col for col in result_df.columns if col not in base_cols + ideal_cols
        ]
        result_df = result_df[ordered_cols]

        # âœ… ç©ºæ¬„åˆ—ã‚’å®‰å…¨ã«é™¤å»ï¼ˆstr/intæ··åœ¨å¯¾å¿œï¼‰
        is_blank = result_df.applymap(lambda x: pd.isna(x) or x == "")
        result_df = result_df.loc[:, ~is_blank.all()]

        st.write(f"ğŸ” æ¤œç´¢çµæœ: {len(result_df)} ä»¶")
        st.dataframe(result_df)

        # Excelå‡ºåŠ›
        if not result_df.empty:
            to_excel = io.BytesIO()
            with pd.ExcelWriter(to_excel, engine='openpyxl') as writer:
                result_df.to_excel(writer, index=False, sheet_name="æ¡å¯¸çµæœ")
            to_excel.seek(0)
            st.download_button("ğŸ“¥ æ¤œç´¢çµæœã‚’Excelã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", data=to_excel,
                               file_name="æ¡å¯¸çµæœ_æ¤œç´¢.xlsx",
                               mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
    except Exception as e:
        st.error(f"èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
